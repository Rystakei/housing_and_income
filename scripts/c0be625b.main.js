$("document").ready(function(){$.getJSON("scripts/june_places_sorted_data.json",function(a){function b(){$.each(a,function(a,b){b.id=a,q.push(b.city),r.push({meta:b.city,value:b.ratio})})}function c(){var b=_.sortBy(a,function(a){return a.city.toLowerCase()});$.each(b,function(a,b){cityOption=$('<option value="'+b.id+'">'+b.city+"</option>"),$("select").append(cityOption),$("select").select2()})}function d(){var b,c="#F8F991";$("#map").vectorMap({map:"us_aea_en",backgroundColor:"white",zoomOnScroll:!1,regionStyle:{initial:{fill:"#333"}},markerStyle:{initial:{fill:c}}}),b=$("#map").vectorMap("get","mapObject"),b.updateSize(),$.each(a,function(a,b){var c=[b.lat,b.lng],d=b.city,e=b.ratio,f=b.region.toLowerCase();t.push({latLng:c,name:d}),s[f].push({latLng:c,name:d,ratio:e})}),b.createMarkers(t)}function e(){$.each(s,function(a,b){var c,d=[];$.each(b,function(a,b){d.push(b.ratio)}),c=(_.reduce(d,function(a,b){return a+b},0)/d.length).toFixed(2),$("#"+a+" .fact-ratio").text(c)})}function f(){chart.on("draw",function(){var b=d3.select("body").selectAll(".ct-point")[0];b.length===a.length&&(i(),j())}),$("select").on("change",function(b){var c=d3.selectAll(".ct-point")[0],d=$(this).val(),e=a[d],f=p(e.house_price),g=p(Number(e.income).toFixed(0)),i=p((Number(e.house_price)/3).toFixed(0)),j=p((Number(e.house_price)/5).toFixed(0));$(".house-price").text(f),$(".city-name").text(e.city),$(".ratio").text(e.ratio),$(".median-income").text(g),$(".recommended-income").text(i),$(".mortgage-income").text(j),h(c[d],b.type),$(".city-data").fadeIn(3e3,function(){$(".city-data").show()})})}function g(a,b){var c=$("#map").vectorMap("get","mapObject");c.removeAllMarkers(),c.createMarkers(a),$(".fact").removeClass("fact-focus"),b.addClass("fact-focus")}function h(a,b){if(d3.selectAll(".ct-point").classed("emphasis",!1),d3.select(a).classed("emphasis",!0),"mouseenter"===b){var c=$(a).attr("ct:key");$("select").first().val(c).change()}}function i(){$.each($(".ct-point"),function(a,b){$(b).attr("ct:key",a)})}function j(){d3.selectAll(".ct-point").on("mouseenter",function(){h(this,d3.event.type)})}function k(){data={labels:q,series:[r]},options={showLine:!1,axisX:{labelInterpolationFnc:function(a,b){return a}},plugins:[Chartist.plugins.tooltip({currency:void 0})]},responsiveOptions=[["screen and (min-width: 640px)",{axisX:{labelInterpolationFnc:function(a,b){return b%4===0?a:null},showGrid:!1,showLabel:!1}}],["screen and (max-width: 640px)",{axisX:{labelInterpolationFnc:function(a){return a[0]},showGrid:!1,showLabel:!1}}]],chart=new Chartist.Line("#cities-chart",data,options,responsiveOptions)}function l(){var a=($("#usa-map-affix"),$("#usa-map-affix").first().parent().offset().top);console.log("offsetTop",a),$("#usa-map-affix").affix({offset:{top:function(){return a},bottom:function(){return console.log("top",$("#usa-map-affix").first().offset().top),console.log("variable",a),a-.1*a}}})}function m(){$(".fact-region").each(function(a,b){var c=$(b),d=c.attr("id");({top:c.offset().top,bottom:c.offset().top+c.outerHeight()});o(s[d],c)})}function n(){var a=$("#lowest-ratio").first(),b=$("#greatest-ratio").first(),c=($("#northeast").first(),$("#cities").first());o({latLng:[42.331427,-83.0457538],name:"Detroit"},a),o({latLng:[37.7749295,-122.4194155],name:"San Francisco"},b),o(t,c)}function o(a,b){var c={top:b.offset().top,bottom:b.offset().top+b.outerHeight()};$(window).scroll(function(){var d=$(window).scrollTop()>=c.top&&$(window).scrollTop()<=c.bottom;d&&g(a,b)})}function p(a){return(a+"").replace(/\b(\d+)((\.\d+)*)\b/g,function(a,b,c){return(b.charAt(0)>0&&!(c||".").lastIndexOf(".")?b.replace(/(\d)(?=(\d{3})+$)/g,"$1,"):b)+c})}var q=[],r=[],s={northeast:[],west:[],south:[],midwest:[]},t=[];b(),c(),d(),n(),m(),e(),l(),k(),i(),j(),f()}),$(window).on("resize",function(){console.log("Resized!");var a=$("#usa-map-affix"),b=$("#usa-map-affix").parent().css("width");a.css("width",b),usaMap=$("#map").vectorMap("get","mapObject"),usaMap.updateSize()})});